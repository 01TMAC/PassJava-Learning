# 反制面试官 | 再也不怕被问CAS.md

# 一、CAS 是什么？

CAS的全称是Compare-And-Swap（比较并交换）

CAS指令需要有三个操作数，变量的当前值，旧的预期值（A），准备设置的新值（B）。

CAS指令执行时，当且仅当V=A时，处理器才会设置V=B，否则不执行更新。

CAS的返回指：V的之前值。

CAS处理过程：原子操作，执行期间不会被其他线程中断。

# 二、能举个例子说明吗？

在上篇讲volatile时，讲到了如何使用原子整型类AtomicInteger来解决volatile的非原子性问题，保证多个线程执行num++的操作，最终执行的结果与单线程一致，输出结果为20000。

这次我们还是用AtomicInteger。

首先定义atomicInteger变量的初始值等于10，主内存中的值设置为10

```java
AtomicInteger atomicInteger = new AtomicInteger(10);
```

然后调用atomicInteger的CAS方法，先比较当前变量atomicInteger的值是否是10，如果是，则将变量的值设置为20

```java
atomicInteger.compareAndSet(10, 20);
```

设置成功，atomicInteger更新为20

当我们再次调用atomicInteger的CAS方法，先比较当前变量atomicInteger的值是否是10，如果是，则将变量的值设置为30

```java
atomicInteger.compareAndSet(10, 30);
```

设置失败，因atomicInteger的当前值为20，而比较值是10，所以比较后，不相等，故不能进行更新。

完整代码如下：

```java
package com.jackson0714.passjava.threads;
import java.util.concurrent.atomic.AtomicInteger;
/**
 演示CAS compareAndSet 比较并交换
 * @author: 悟空聊架构
 * @create: 2020-08-17
 */
public class CASDemo {
    public static void  main(String[] args) {
        AtomicInteger atomicInteger = new AtomicInteger(10);
        Boolean result1 = atomicInteger.compareAndSet(10,20);
        System.out.printf("当前atomicInteger变量的值:%d 比较结果%s\r\n", atomicInteger.get(), result1);
        Boolean result2 = atomicInteger.compareAndSet(10,30);
        System.out.printf("当前atomicInteger变量的值:%d, 比较结果%s\n" , atomicInteger.get(), result2);
    }
}
```

执行结果如下：

``` java
当前atomicInteger变量的值:20 比较结果true
当前atomicInteger变量的值:20, 比较结果false
```

![atomicInteger比较并交换的示例结果](http://cdn.jayh.club/blog/20200818/0bMPvFoWDkew.png?imageslim)