# Java并发多线程第三弹：用积木讲解ABA原理

## 背景

上一节我们讲了[程序员深夜惨遭老婆鄙视，原因竟是CAS原理太简单？](https://juejin.im/post/6863799243182702599)，留了一个彩蛋给大家，ABA问题是怎么出现的，为什么不是AAB拖拉机，AAA金花，4个A炸弹 ？这一篇我们再来揭开ABA的神秘面纱。

## 可怕的面试

面试的时候我们也经常遭遇面试官的连环追问：

- CAS概念？
- Unsafe类是干啥用的？
- CAS底层实现是怎么样的？
- ABA问题什么场景下会出现？
- 原子引用更新是啥？
- 如何避免ABA问题？

## 用积木讲解ABA问题

**案例：甲看见一个三角形积木，觉得不好看，想替换成五边形，但是乙想把积木替换成四边形。（前提条件，只能被替换一次）**

可能出现的过程如下图所示：

- 第一步：乙先抢到了积木，将`三角形A1`积木替换成`五角星B1`
- 第二步：乙将`五角星B1`替换成`五边形B2`
- 第三步：乙将`五边形B2`替换成`棱形B3`
- 第四步：乙将`棱形B3`替换成`六边形B4`
- 第五步：乙将`六边形B4`替换成`三角形A2 `
- 第六步：甲看到积木还是三角形，认为乙没有替换，所以将`三角形V`替换成了`五边形B`。

**讲解：**第一步道第五步，都是乙在替换，但最后还是替换成了三角形（即时不是同一个三角形），这个就是ABA，A1指最开始是三角形，B指中间被替换的B1/B2/B3/B4，第二个A就是第五步中的A2，中间不论经过怎么样的形状替换，最后还是变成了三角形。然后甲再将A2和A1进行形状比较，发现都是三角形，所以认为乙没有动过积木，甲可以进行替换。**这个就是比较并替换（CAS）中的ABA问题。**

![用积木讲解ABA过程](http://cdn.jayh.club/blog/20200824/9n9k0GGAN9fO.png?imageslim)

**小结：**CAS只管开头和结尾，中间过程不关心，只要头尾相同，则认为可以进行修改，而中间过程很可能被其他人改过。









