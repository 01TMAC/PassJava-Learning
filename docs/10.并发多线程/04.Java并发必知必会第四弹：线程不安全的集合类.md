# Java并发必知必会第四弹：用积木讲解集合类

本篇主要内容如下



本篇所有示例代码已更新到[Github](https://github.com/Jackson0714/PassJava-Learning)

本篇文章已收纳到我的[Java在线文档](www.jayh.club)

**Java并发必知必会系列：**

[1.反制面试官 | 14张原理图 | 再也不怕被问 volatile!](https://juejin.im/post/6861885337568804871)

[2.程序员深夜惨遭老婆鄙视，原因竟是CAS原理太简单？](https://juejin.im/post/6863799243182702599)

[3.用积木讲解ABA原理 | 老婆居然又听懂了！](https://juejin.im/post/6864945088721027079)

## 一、线程不安全之ArrayList

### 1.1、ArrayList的底层初始化操作

首先我们来复习下ArrayList的使用，下面是初始化一个ArrayList，数组存放的是Integer类型的值。

``` java
new ArrayList<Integer>();
```

那么底层做了什么操作呢？

源码：

```java
/**
 * Constructs an empty list with an initial capacity of ten.
 */
public ArrayList() {
    this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;
}
```

这段英文翻译过来就是：创建了一个空数组，容量为10

### 1.2、ArrayList的底层Add操作

```java
public boolean add(E e) {
    ensureCapacityInternal(size + 1);  // Increments modCount!!
    elementData[size++] = e;
    return true;
}
```

重点是这一步：elementData[size++] = e; size++和elementData[xx]=e，这两个操作都不是原子操作。

### 1.3、ArrayList单线程环境是否安全？

我们通过一个`添加积木的例子`来说明单线程下ArrayList是线程安全的。

![ArrayList单线程下添加元素](http://cdn.jayh.club/blog/20200827/150707103.png)

 **添加顺序**：三角形A、四边形B、五边形C、六边形D、五角星E。

**代码实现：**

（1）积木类还是沿用上两篇文章中用到的`BuildingBlock`

```java
/**
 * 积木类
 * @author: 悟空聊架构
 * @create: 2020-08-27
 */
class BuildingBlockWithName {
    String shape;
    String name;
    public BuildingBlockWithName(String shape, String name) {
        this.shape = shape;
        this.name = name;
    }
    @Override
    public String toString() {
        return "BuildingBlockWithName{" + "shape='" + shape + ",name=" + name +'}';
    }
}
```

（2）初始化一个ArrayList

```java
ArrayList<BuildingBlock> arrayList = new ArrayList<>();
```

（3）依次添加三角形A、四边形B、五边形C、六边形D、五角星E

```java
arrayList.add(new BuildingBlockWithName("三角形", "A"));
arrayList.add(new BuildingBlockWithName("四边形", "B"));
arrayList.add(new BuildingBlockWithName("五边形", "C"));
arrayList.add(new BuildingBlockWithName("六边形", "D"));
arrayList.add(new BuildingBlockWithName("五角星", "E"));
```

（4）验证`arrayList`中元素的内容和顺序是否和添加的一致

``` java
BuildingBlockWithName{shape='三角形,name=A}
BuildingBlockWithName{shape='四边形,name=B}
BuildingBlockWithName{shape='五边形,name=C}
BuildingBlockWithName{shape='六边形,name=D}
BuildingBlockWithName{shape='五角星,name=E}
```

我们看到结果确实是一致的。

**小结：**单线程环境中，ArrayList是线程安全的。

## 1.4、多线程下ArrayList是不安全的

场景如下：20个线程不断

![多线程数组存放元素](http://cdn.jayh.club/blog/20200827/172146229.png)



![多线程下ArrayList是不安全的](http://cdn.jayh.club/blog/20200827/154511673.png)

**打印结果：**

![打印结果](http://cdn.jayh.club/blog/20200827/172244687.png)

执行过程中，会报一个Error:

``` java
Exception in thread "10" Exception in thread "13" java.util.ConcurrentModificationException
```



![mark](http://cdn.jayh.club/blog/20200827/172451907.png)