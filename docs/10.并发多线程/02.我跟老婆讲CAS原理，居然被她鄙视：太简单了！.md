# 我跟老婆讲CAS原理，居然被她鄙视：太简单了！



对话如下：

> 老婆：这画的图是啥意思，怎么还有三角形，四边形？
>
> 我：我在画CAS的原理，要不我跟你讲一遍？
>
> 老婆：好呀！

![请开始你的表演](http://cdn.jayh.club/blog/20200819/QrgY3SbBks2v.png?imageslim)

**案例：甲看见一个三角形积木，觉得不好看，想替换成五边形，但是乙想把积木替换成四边形。（前提条件，只能被替换一次）**

![案例](http://cdn.jayh.club/blog/20200818/OEvyi3KQE95G.png?imageslim)

甲比较鸡贼，想到了一个办法：“我把积木带到另外一个房间里面去替换，并上锁，就不会被别人打扰了。”（这里用到了`排他锁synchronized`）

乙觉得甲太不厚道：“房间上了锁，我进不去，我也看不见积木长啥样。（因上了锁，所以不能访问）”

![甲把房间锁住了](http://cdn.jayh.club/blog/20200818/zp0QVrLMySPu.png?imageslim)

于是甲、乙想到了另外一个办法：**谁先抢到积木，谁先替换，如果积木形状变了，则不允许其他人再次替换**。（`比较并替换CAS`）

于是他们就开始抢三角形积木：

   - 场景1：`甲抢到，替换成五边形，乙不能替换`

         - 假如甲先抢到了，积木还是三角形的，就把三角形替换成五边形了。

     ![甲先抢到，替换成五边形](http://cdn.jayh.club/blog/20200819/PrE1uNFiib8y.png?imageslim)

        - 乙后抢到，积木已经变为五边形了，乙就没机会替换了（因为甲、乙共一次替换机会）。

          ![mark](http://cdn.jayh.club/blog/20200818/leIc0y5ne6sO.png?imageslim)

     

- 场景2：`乙抢到未替换，甲替换成功`

  - 假如乙先抢到了，但是突然觉得三角形也挺好看的，没有替换，放下积木就走开了。

  - 然后甲抢到了积木，积木还是三角形的，想到乙没有替换，就把三角形替换成五边形了。

  ![乙抢到未替换，甲替换成功](http://cdn.jayh.club/blog/20200818/HzprJycWtrux.png?imageslim)

- 场景3：`乙抢到，替换成三角形，甲替换成五边形，ABA问题`
  - 假如乙先抢到了，但是觉得这个三角形是旧的，就换了另外一个一摸一样的三角形，只是积木比较新。
  - 然后甲抢到了积木，积木还是三角形的，想到乙没有替换，就把三角形替换成五边形了。

![乙抢到，替换成三角形，甲替换成五边形，ABA问题](http://cdn.jayh.club/blog/20200819/hC9pmBC6olW7.png?imageslim)

老婆听完后，觉得这三种场景都太简单了，**原来计算机这么简单，早知道我也去学计算机**。。。

![mark](http://cdn.jayh.club/blog/20200819/OuWkYsoSzQMe.png?imageslim)

被无情鄙视了，好在老婆居然听懂了，不知道大家听懂没？

回归正传，我们用计算机术语来讲下CAS的原理

# 一、CAS简介

CAS的全称：Compare-And-Swap（比较并交换）。比较变量的现在值与之前的值是否一致，若一致则替换，否则不替换。

CAS指令需要有三个操作数，变量的当前值（V），旧的预期值（A），准备设置的新值（B）。

CAS指令执行条件，当且仅当V=A时，处理器才会设置V=B，否则不执行更新。

CAS的返回指：V的之前值。

CAS处理过程：原子操作，执行期间不会被其他线程中断。

# 二、能写几行代码说明下吗？

在上篇讲volatile时，讲到了如何使用原子整型类AtomicInteger来解决volatile的非原子性问题，保证多个线程执行num++的操作，最终执行的结果与单线程一致，输出结果为20000。

这次我们还是用AtomicInteger。

首先定义atomicInteger变量的初始值等于10，主内存中的值设置为10

```java
AtomicInteger atomicInteger = new AtomicInteger(10);
```

然后调用atomicInteger的CAS方法，先比较当前变量atomicInteger的值是否是10，如果是，则将变量的值设置为20

```java
atomicInteger.compareAndSet(10, 20);
```

设置成功，atomicInteger更新为20

当我们再次调用atomicInteger的CAS方法，先比较当前变量atomicInteger的值是否是10，如果是，则将变量的值设置为30

```java
atomicInteger.compareAndSet(10, 30);
```

设置失败，因atomicInteger的当前值为20，而比较值是10，**所以比较后，不相等，故不能进行更新**。

完整代码如下：

```java
package com.jackson0714.passjava.threads;
import java.util.concurrent.atomic.AtomicInteger;
/**
 演示CAS compareAndSet 比较并交换
 * @author: 悟空聊架构
 * @create: 2020-08-17
 */
public class CASDemo {
    public static void  main(String[] args) {
        AtomicInteger atomicInteger = new AtomicInteger(10);
        Boolean result1 = atomicInteger.compareAndSet(10,20);
        System.out.printf("当前atomicInteger变量的值:%d 比较结果%s\r\n", atomicInteger.get(), result1);
        Boolean result2 = atomicInteger.compareAndSet(10,30);
        System.out.printf("当前atomicInteger变量的值:%d, 比较结果%s\n" , atomicInteger.get(), result2);
    }
}
```

执行结果如下：

``` java
当前atomicInteger变量的值:20 比较结果true
当前atomicInteger变量的值:20, 比较结果false
```

![atomicInteger比较并交换的示例结果](http://cdn.jayh.club/blog/20200818/0bMPvFoWDkew.png?imageslim)







