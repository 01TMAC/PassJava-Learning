# 都12届双11了，还不懂流量防控？



临近双十一，从 2009 年第一届双十一开始，成交量只有 5000 万，到去年 2019 年，成交量达到了 2684 亿。今年迎来了第十二届双十一，想想都挺激动。阿里人喜欢将双十一视为 Team Building（团队建设），广为流传的一句话：打仗是最好的团建，没有参加过双十一的叫同事，参加过双十一的叫战友。

本篇将会讲解微服务架构中经常被一线大厂使用的两款流量防控组件：Sentinel 和 Hystrix，以及对它们的横向对比。

## 一、熔断&降级&限流&隔离

面对高并发的流量，我们通常会使用四种方式（熔断&降级&限流&隔离）来防止瞬时大流量对系统的冲击。而今天要介绍的这两款流量防卫兵，是专门用在这方面的。下面我先给同学扫个小盲。

- **什么是熔断 ？** 

![熔断场景图@悟空聊架构](微服务架构中的两款流量防卫兵.assets/image-20201101131233611.png)

关键字：`断路保护`。比如 A 服务调用 B 服务，由于网络问题或 B 服务宕机了或 B 服务的处理时间长，导致请求的时间超长，如果在一定时间内多次出现这种情况，就可以直接将 B 断路了（A 不再请求B）。而调用 B 服务的请求直接返回降级数据，不必等待 B 服务的执行。因此 B 服务的问题，不会级联影响到 A 服务。

- **什么是降级 ？** 

![降级场景图@悟空聊架构](微服务架构中的两款流量防卫兵.assets/image-20201101131624248.png)

关键字：`返回降级数据`。网站处于流量高峰期，服务器压力剧增，根据当前业务情况及流量，对一些服务和页面进行有策略的降级（停止服务，所有的调用直接返回降级数据）。以此缓解服务器资源的压力，保证核心业务的正常运行，保持了客户和大部分客户得到正确的响应。降级数据可以简单理解为快速返回了一个 false，前端页面告诉用户“服务器当前正忙，请稍后再试。”

- **什么是限流？** 

  ![限流场景图@悟空聊架构](微服务架构中的两款流量防卫兵.assets/image-20201101132129234.png)

  对请求的流量进行控制， 只`放行部分请求`，使服务能够承担不超过自己能力的流量压力。

- **熔断和降级的相同点？**  

  - 熔断和限流都是为了保证集群大部分服务的可用性和可靠性。防止核心服务崩溃。
  - 给终端用户的感受就是某个功能不可用。

- **熔断和降级的不同点？** 

  - 熔断是被调用放出现了故障，主动触发的操作。
  - 降级是基于全局考虑，停止某些正常服务，释放资源。
  
- **什么是隔离？** 

  - 每个服务看作一个独立运行的系统，即使某一个系统有问题，也不会影响其他服务。


## 二、Hystrix 介绍

### Hystrix 的历史

Hystrix 是高可用性保障的一个框架。由 Netflix 出品（Netflix可以理解为国内的爱奇艺等视频网站）。

2011 年，其中的 API 团队为了提升系统的可用性和稳定性，发展出了 Hystrix 框架。

2012 年，Hystrix 区域比较成熟稳定。其他团队也开始使用 Hystrix。

2018 年 11 月，Hystrix在其 Github 主页宣布，不再开放新功能，推荐开发者使用其他仍然活跃的开源项目。但是 Hystrix 价值依旧很大，功能强大，国内很多一线互联网公司在使用。

### Hystrix 设计理念

- 阻止服务的雪崩效应。
- 快速失败和快速恢复。
- 优雅降级。
- 使用资源隔离技术，如 bulkhead（舱壁隔离技术）、swimlane（泳道技术）、circuit breaker（断路技术）。
- 近实时的监控、报警及运维操作。

### Hystrix 线程池隔离技术

使用线程池隔离，比如说有 3 个服务 A、B、C，每个服务的线程池分配 10，20，30个线程，当 A 服务线程池中的 10 个线程都拿出来使用后，如果调用服务 A 的请求量增加，还想再增加线程是不行的，因为 A 服务分配的线程已经用完了，不会拿其他的服务的线程，这样就不会影响其他服务了。Hystrix 默认使用线程池隔离模式。

![线程池隔离技术](微服务架构中的两款流量防卫兵.assets/image-20201101102053470.png)

#### 线程池隔离技术优点

- 依赖的服务都有隔离的线程池，即使自己的此案成池满了，也不会影响任何其他其他的服务调用。
- 线程池的健康状态会上报，可以近实时修改依赖服务的调用配置。
- 线程池具有异步特性，可以构建一层异步调用层。
- 具有超时检测的机制，尤其在服务间调用特别有用。

#### 线程池隔离技术缺点

- 线程池本身就会带来一些问题，比如线程切换，线程管理，无疑增加了 CPU 的开销。
- 如果线程池中的线程利用率很低，则无疑是一种浪费。



### Hystrix 信号量隔离技术

如下图所示：简单来说就是一个池子里面放着一定数量的信号量，服务 A 每次调用服务 B 之前，需要从池子里面申请信号量，申请到了，才能去调用 B 服务。

![获取信号量](微服务架构中的两款流量防卫兵.assets/image-20201101103520316.png)

#### 线程池隔离和信号量的场景对比

- **线程池隔离技术** ，适合大部分场景，但需要设置服务的超时时间。
- **信号量隔离技术** ，适合内部比较复杂的业务，不涉及网络请求问题。

### Hystrix 断路器原理





## 二、Sentinel 和 Hystrix

  一、Sentinel 是什么？

Sentinel：分布式系统中的流量防卫兵。

![Hystix 和 Sentinel 对比](17.SpringCloud整合Alibaba-Sentinel组件.assets/image-20201024080239832.png)