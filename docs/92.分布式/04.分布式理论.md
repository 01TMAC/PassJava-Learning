张三丰教我的分布式太极拳，我全忘了

> 背景：元朝赵敏郡主携带一帮高手围攻武当，武当派掌门张三丰被暗算，传了一套武功给张无忌用来对付赵敏的手下。这套武功就是太极拳。
>
> 张三丰：无忌，你可记得多少招式？
>
> 张无忌：我全忘了！
>
> 张三丰：很好，你只要记住把玄冥二老打趴下就可以了。

上篇用三国杀讲分布式中的拜占庭将军问题，还挺有意思的，这次我们用太极拳来聊下剩下的三大理论：

- CAP 理论
- ACID 理论
- BASE 理论

太极拳的精髓：以柔克刚，刚柔并进，四两拨千斤，无招胜有招。

我把 CAP 理论称作`太极`，ACID 理论成为`阳`或`刚`，BASE 理论称为`阴`或`柔`。ACID 理论追求一致性，BASE 理论本来就叫做柔性事务，追求的是可用性。那张无忌为什么会全忘了还打败了玄冥二老呢？因为太极拳的精髓拳意，无招胜有招。

## 刚或柔是个问题

CAP 理论是对分布式系统的特性做了一个高度的抽象，变成了三大指标：

- 一致性（Consistency）
- 可用性（Availability）
- 分区容错性（Partition Tolerance）

分布式中的一致性，我们可以理解为客户端的每次`读操作`，不管访问的是哪个几点，要么督导的都是同一份最新写入的数据，要么读取失败。这就很刚了，不能说这种`刚`不好，在很多场景中，也确实需要保证高度的一致性。

为了帮助大家理解一致性，我举个`三国`的故事：

刘备作为主公，带领关羽和张飞攻打曹操，最开始的进攻策略是从北边进攻。刘备发现从北边进攻不妙，于是先给关羽军队下达进从南边进攻的命令，但是关羽和刘备没有告诉张飞的军队，要从南边进攻，刘备次日看到关羽从北边进攻，张飞从南边进攻，这不就乱套了吗？如下图所示：

![刘关张攻打曹操](http://cdn.jayh.club/blog/20201227/3cRbQVF2gFjW.png?imageslim)

那放到分布式系统中该如何理解呢？

- 初始环境：客户端查询或更新节点 1 和 节点 2，两个节点存的值 A = 1。

![初始环境](http://cdn.jayh.club/blog/20201227/qjcfzRA61Jne.png?imageslim)

- 客户端更新节点 1 中 A 的值，设置 A = 5。

![客户端更新节点 1](http://cdn.jayh.club/blog/20201227/Vtb8YElS3Yhr.png?imageslim)

- 节点 1 将 A 的值更新为 5 后，返回更新成功给客户端。

  ![节点 1 返回更新成功](http://cdn.jayh.club/blog/20201227/ajCr3gVEcJWy.png?imageslim)

- 客户端访问到了节点 2 ，请求获取 A 的值，结果返回 A = 1。这和节点 1 中存储的 A 的值就不一致了。

![客户端访问到节点 2 ](http://cdn.jayh.club/blog/20201227/cdBBEgbCpWE3.png?imageslim)

- 那么怎么保证两个节点中的值都是 A = 5 呢？客户端将节点 1 更新后，节点 2 也需要更新，才能告诉客户端更新成功了。

![mark](http://cdn.jayh.club/blog/20201227/i9VOHtWYwlNx.png?imageslim)

- 两个节点都更新成功后，客户端访问其中任意一个节点获取到的都是 A = 5。这个就叫做一致性。

![两个节点都更新后](http://cdn.jayh.club/blog/20201228/vrEgf6tQIG5K.png?imageslim)

`一致性`强调的是数据正确，每次读取节点中的数据都是最新写入的数据。这个我称作`刚`。

但是我们生产的集群环境下如果发生分区故障时（节点失联，节点无法响应，节点无法写入数据），客户端查询节点时，我们不能返回错误信息给客户端。比如说业务集群中的一些关键系统，如注册中心，不能因为某个节点失联了，就不响应最新的数据。那么相关的业务也获取不到正确的注册信息而导致系统瘫痪。

`可用性`就派上用场了，牺牲数据准确性，每个节点使用本地数据来响应客户端的请求。另外当节点不可用时，可以使用快速失败策略，至少不能让服务长时间不能响应可用性强调的是服务可用，不保证数据正确。这个我称作`柔`。

如下图所示：节点 1 和节点 2 返回给客户端的值分别是 A = 5 和 A = 1，也就是节点 1 和 节点 2 并没有保证数据一致性，而是考虑了节点的可用性。

`分区容错性`的含义就是节点间出现任意数量的消息丢失或高延迟的时候，系统仍然在继续工作。分布式系统告诉客户端，我的内部不论出现什么样的数据同步问题，我会一直运行。强调的是集群堆分区故障的容错能力。

![mark](http://cdn.jayh.club/blog/20201228/WbbKXtyNvsVB.png?imageslim)



### CAP 三角

那么这三个指标又有什么关系呢？这个就是我们经常听到的 `CAP` 理论。C 代表一致性（Consistency），A 代表可用性（Availability）、P 代表分区容错性（Partition Tolerance）。

对于分布式系统，CAP 三个指标只能选择其中两个。

- CA：保证一致性和可用性。当分布式系统正常运行时（大部分时候所处的状态），这个时候不需要 P，那么 C 和 A 能够同时保证。只有在发生分区故障时，才需要 P，这个时候就只能在 C 和 A 之间做出选择。

- CP：保证数据的一致性和分区容错性，比如配置信息，必须保证每个节点存的都是最新的，正确的数据。
- AP：保证分布式系统的可用性和分区容错性。典型应用 

## 刚柔并进



## 无招胜有招