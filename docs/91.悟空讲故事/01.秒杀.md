

![A-731电商星球](http://cdn.jayh.club/blog/20201020/135806672.png)

## 星球简介

地点：β-102 星系，`A-731电商星球`。

时间：新纪元 2036 年。

星球简介：

- 中文名：A-731电商星球

- 外文名：A-731 Mall

- 分类：行星

- 公转周期：一年

- 常驻用户：
  - 各种请求
     - 下单请求
     - 退单请求
     - 发货请求等等
  - 中间件工作者
    - Nginx 工作者
    - CDN 工作者
    - Redis 工作者等等

- 星球总历史：二十万年

## 星球危机

我是一个秒杀请求，每天的工作就是将秒杀请求的数据运送给订单星球。

这天我在 Nginx 转发服务器上遇见了请求**小空** ，我跟小空说有重要消息不方便在现在告诉他，下班再约，然后就都匆匆赶路了，因为我俩都要快速将请求数据运送到订单星球。

我和小空晚上十点下班后来到一家酒吧，点了两杯 `mojito`，找了一个角落坐下。

小空：你最近看起来心事重重。

我：你有没有发现最近我们星球的订单数急剧增加，每天有一千万订单数据产生，也不是一天、两天的事了。

小空：难怪我每天加班到晚上十点来运送请求数据。

我：我有个舅舅在航天局上班，告诉我说我们星球承载不了那么多请求和订单数据，不久就会出现**行星大爆炸** 。

小空：那怎么办？

我：可以去 100 光年外的 T-220 星球，但是只能通过`秒杀通道`坐`时空穿梭机`去那颗星球。而且有名额限制，不知道我有没有机会坐上。

我：明天通道会开启两次，上午十点和下午两点。你明天和我一起去吧！

小空：好的。

**涉及的知识点：** 

- 这里的行星大爆炸指的是什么？
  - 因订单数据量很大，数据库撑不住了。
  - 因每天有大量请求发送到服务器，服务器也扛不住了。
- 秒杀通道每天开启两次代表了什么？
  - 流量削峰，将流量分摊到两个秒杀场次。
  - 当然流量削峰的手段还有输入验证、加入购物车再秒杀的操作，这种也属于秒杀设计中的流量削峰。

## 秒杀通道

地点：A-731 星球机场

时间：09 : 45

“请前往 T-220 星球的请求旅客到 Y1 站台排队等待进入特殊通道， 15 分钟后开始预售机票”。大厅的广播连续播放了三遍。

我走向了特殊通道，看到通道旁立着一个牌子：秒杀通道，只给秒杀请求使用。

**涉及知识点：** 

- 秒杀通道为什么单独弄了条通道？
  - 秒杀业务为了不影响系统其他业务单独部署了一套秒杀系统。

## 实时大屏

一抬头看到通道上方有一个大屏，在不断播放 T-220 星球的照片，以及机票的商品信息。

有两个穿制服的工作者正在大屏旁巡逻。一个制服上印着 Nginx，一个制服上印着 CDN。

**涉及知识点：** 

- 大屏的商品详情页并不是通过发送请求从后台服务器拿到的。实现了动静分离。
- 什么是静？什么是动？
  - 静态资源比如 HTML 文件极少变化，就可以专门放到一台服务器上，直接访问，不需要与后台服务器交互（比如 Tomcat）。
  - 动态资源比如需要从后台拿到有多少人购买了商品，发送下单请求来存储数据，这些都称作动态资源，不能狭隘的理解为看得见的资源，广义上可以包括获取逻辑处理的结果，执行存储数据等操作。

- Nginx 制服：

  - 商品详情页是一个静态页面，将这些静态页面存储到 Nginx 服务器上，访问静态资源时，请求先到 Nginx，然后 Nginx 服务器通过请求的 URL 链接来匹配是否是访问的静态资源。
  - 穿 Nginx 制服的工作者在维护 Nginx 的静态和动态资源。

- 缺少一张图！！！！

- 比如下面的 Nginx 配置，就实现了动静分离。

  ``` json
  ###静态资源访问
  server {
    listen       80;
    server_name  static.passjava.cn;
    location /static {
         root /user/wukong/passjava/static;
         index  index.html index.htm;
     }
  }
  ###动态资源访问
   server {
    listen       80;
    server_name  www.passjava.cn;
      
    location / {
      proxy_pass http://127.0.0.1:8080;
       index  index.html index.htm;
     }
  }
  ```

- CDN 制服

  - 什么是 CDN：CDN 大白话解释就是用户就近获取资源，减少网络传输时间，提高访问速度。
  - Nginx 上放 HTML文件，而 CDN 上则放 HTML 引入的图片文件、脚本文件。
  - 穿 CDN 制服的工作者在维护 CDN 的资源。

## 验证通道

时间：10:00

“验证通道已开启，请携带加密密码进入！” 又是播放了三遍广播。

**涉及的知识点：** 

- 为什么需要加密密码？
  - 为了防止大量模拟的秒杀请求进入业务处理流程，所以先加一道验证，丢弃这些假请求。
  - 前端网页先发送请求拿到加密密码，点击抢购时，请求体中携带加密密码，后端校验加密密码是否匹配。可以通过 MD5 加密。





大家一下子全部涌入到购票窗口了，估计有一万个和我一样的请求涌入进去。在拥挤的请求当中，我发现一些请求带着面具，



参考文章：

https://www.cnblogs.com/haoworld/p/nginx-shi-xian-dong-jing-fen-li.html



