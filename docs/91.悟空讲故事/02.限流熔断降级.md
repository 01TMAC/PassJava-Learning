# 东汉末年，他们把熔断限流玩到了极致

> 滚滚长江东逝水，浪花淘尽英雄。
>
> 是非成败转头空。青山依旧在，几度夕阳红。
>
> 白发渔樵江渚上，惯看秋月春风。
>
> 一壶浊酒喜相逢。古今多少事，都付笑谈中。
>
> -- 来自《三国演义》

# 一、赤壁之战

话说东汉末年，曹操、孙权、刘备在赤壁市进行了一次争夺老大位置的大战，这就是有名的`赤壁之战`。

## 1.1 还原赤壁之战

曹操统一北方后，南下打败了刘备，占领荆襄之地后，还想干掉东边的孙权，于是刘备和孙权一起联合抗击曹军。

曹操的军队大部分都是北方的，对于水上作战的经验非常欠缺，而且很多士兵晕船，于是曹操命令军队将`船尾用铁索相连`，减弱了风浪颠簸，利于士兵演练。

缺少连环船的图片！！！



 孙权的部将黄盖看出了曹军`连环船`的弱点，说道：曹操是真的蠢啊，把船连着，如果船烧着了，其他船会跟着一起烧着的。锁链不易解开，船都逃不了了。我们用火攻，直接把曹军干趴下。

周瑜：但如何接近他们的船呢？

黄盖：我用诈降带几艘船出发，船上载浸油的干草，等接近曹军时，点燃干草，冲向曹军的连环船，引燃他们的船只。

周瑜：秒啊！

赤壁之战那天，火船乘风闯入曹军船阵，顿时一片火海。联军乘势攻击，曹军伤亡惨重，最后以联军大胜结束。

## 1.2 战情分析

周瑜和黄盖看出了连环船的弱点：如果一只船被烧着了，也会把连着的船烧着。

这就很像我们的系统中出现的`服务雪崩`问题。

假定我们系统引进了微服务的思想，将多个服务进行拆分，每个服务都是通过接口调用来完成的，看似功能通过微服务化后，功能和职责单一，正是我们想要的.

但随着业务的增长，服务的数量也是`随之增多`，逻辑也会`更加复杂`，一个服务的某个逻辑需要`依赖`多个其他服务才能完成。假如一个被依赖的服务不能向上游的服务提供服务，则很可能造成雪崩效应，最后导致整个服务不可访问。

就像雪山上某一处出现积雪崩塌的现象，慢慢地带动其他片区的积雪崩塌，产生了级联反应，最后造成大片的积雪崩塌，这就是常见的雪崩场景。

**小结：** 一个服务失败，导致整条链路的服务都失败的场景，称为服务雪崩。

那曹军应该怎么避免这个问题呢？别急，后面再看答案。

## 1.3 系统中的雪崩效应

微服务之间往往采用 RPC 或者 HTTP 调用，一般都会设置调用超时的限制，或者通过失败重试机制来确保服务成功执行。但如果不考虑服务的熔断和限流，还是很容易产生服务雪崩的。下面用例子来讲解下雪崩效应是怎么产生的。

![雪崩效应](https://img-blog.csdnimg.cn/img_convert/cbc572056ef4ad0cec9afe40f57e9541.png)

- 我们系统中三个服务：`订单服务`、`商品服务`、`库存服务`。
- 下单场景：用户下单了一个商品，客户端调用订单服务来生成预付款订单，订单服务调用商品服务查看下单的哪款商品，商品服务调用库存服务判断这款商品是否有库存，如有库存，则可以生成预付款订单。

- 假定因双十一流量暴增，库存服务不可用（如响应超时等），库存服务收到的很多请求都未处理完，它将无法处理更多请求。
- 而上游的商品服务依赖库存服务，商品服务的超时和重试机制会被执行。商品服务新的调用不断产生，会导致商品服务的调用被大量积压，产生大量的调用等待和重试调用，慢慢耗尽商品服务的资源，比如内存，结果导致商品服务也宕机了。
- 而订单服务也会重走商品服务的老路。结果就是三个服务都不可用了。

### 1.4 造成雪崩的真实场景

### 1.4.1 服务提供者不可用

- 硬件故障，如网络故障、硬盘损坏等。
- 程序的 bug，如算法需要占用大量 CPU 的计算时间导致 CPU 使用率过高。
- 缓存击穿：比如应用刚重启，短时间内缓存是失效的，导致大量请求直接访问到了数据库，数据库不堪重负，服务不可用。
- 秒杀和大促：服务短时间承载不了那么多请求量。

### 1.4.2 重试加大流量

- 用户连续重试，比如用户看到界面上没有响应，所以又操作了一遍，结果又增加了一倍请求量。
- 程序重试机制，比如代码中有多次重试的逻辑，一次失败后，过几秒后再重试，重试个三次就取消重试，走异常处理分支了。也是增加了请求量。

## 1.5 如何防止雪崩

### 方法

出问题前预防：限流、主动降级、隔离

出问题修复：熔断、被动降级



可以用绳子代替锁链，因绳子更容易割断（熔断机制）。将船划分到几个区域，区域之间保持一定距离（资源隔离）。



**服务熔断：**

设置服务的超时，当被调用的服务某段时间内失败率达到某个阈值，则对该服务开启短路保护，后来的请求不调用这个服务，直接返回默认的数据。

